---
- name: PostgreSQL installation
  apt: name=postgresql-13 state=present update_cache=yes

- name: Write your configuration in postgresql.conf
  vars:
    listen_addresses: '*'
    port: 5000
    max_connections: 30
    ram_memory: 1024
  template:
    src: postgresql.conf.j2
    dest: /etc/postgresql/13/main/postgresql.conf
    owner: postgres
    group: postgres
    mode: '0644'

- name: Write your access security in pg_hba.conf
  vars:
    database: 'all'
    role: 'all'
    address: '192.168.1.101/24'
    method: 'scram-sha-256'
    gateway: '192.168.1.1/24'
  template:
    src: pg_hba.conf.j2
    dest: /etc/postgresql/13/main/pg_hba.conf
    owner: postgres
    group: postgres
    mode: '0640'

- name: Restart postgres daemon for reload all new setttings
  shell: systemctl restart postgresql

- name: PostgreSQL upload vagrant.sql
  vars:
    user_name: vagrant
    user_password: "'vagrant'"
  template:
    src: vagrant.sql.j2
    dest: /tmp/vagrant.sql
    owner: postgres
    group: postgres
    mode: '0740'

- name: Execute vagrant.sql
  shell: |
    su postgres -c "psql -f /tmp/vagrant.sql > /tmp/vagrant.log 2> /tmp/vagrant.err" &&
    rm /tmp/vagrant.sql
...
